<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MLB Player Analyzer</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,600;1,9..40,300&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --navy: #0a1628;
      --navy-mid: #112040;
      --navy-light: #1a3060;
      --red: #c8102e;
      --red-dark: #9e0c24;
      --gold: #e8c84a;
      --gold-dim: #b89c30;
      --white: #f0f4ff;
      --gray: #8899bb;
      --card-bg: #0d1e3a;
      --border: rgba(100,140,220,0.15);
    }

    body {
      background-color: var(--navy);
      color: var(--white);
      font-family: 'DM Sans', sans-serif;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* ── BACKGROUND ── */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background:
        radial-gradient(ellipse 80% 60% at 50% -10%, rgba(200,16,46,0.18) 0%, transparent 60%),
        radial-gradient(ellipse 60% 40% at 100% 100%, rgba(26,48,96,0.6) 0%, transparent 60%),
        repeating-linear-gradient(
          0deg,
          transparent,
          transparent 59px,
          rgba(100,140,220,0.04) 59px,
          rgba(100,140,220,0.04) 60px
        ),
        repeating-linear-gradient(
          90deg,
          transparent,
          transparent 59px,
          rgba(100,140,220,0.04) 59px,
          rgba(100,140,220,0.04) 60px
        );
      pointer-events: none;
      z-index: 0;
    }

    .wrapper {
      position: relative;
      z-index: 1;
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 24px 80px;
    }

    /* ── HEADER ── */
    header {
      padding: 52px 0 40px;
      display: flex;
      align-items: flex-end;
      gap: 20px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 48px;
    }


    .header-text h1 {
      font-family: 'Bebas Neue', sans-serif;
      font-size: clamp(2rem, 5vw, 3.4rem);
      letter-spacing: 2px;
      line-height: 1;
      color: var(--white);
    }

    .header-text p {
      font-size: 0.9rem;
      color: var(--gray);
      margin-top: 4px;
      font-weight: 300;
    }

    /* ── SECTION LABELS ── */
    .section-label {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 0.8rem;
      letter-spacing: 3px;
      color: var(--gold);
      text-transform: uppercase;
      margin-bottom: 10px;
    }

    /* ── CONTROLS PANEL ── */
    .controls {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 32px;
      margin-bottom: 40px;
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 20px;
      align-items: end;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .control-group label {
      font-size: 0.75rem;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--gray);
      font-weight: 600;
    }

    select {
      background: var(--navy-mid);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--white);
      font-family: 'DM Sans', sans-serif;
      font-size: 0.95rem;
      padding: 12px 16px;
      appearance: none;
      cursor: pointer;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%238899bb' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 14px center;
      padding-right: 38px;
      transition: border-color 0.2s, box-shadow 0.2s;
      width: 100%;
    }

    select:focus {
      outline: none;
      border-color: var(--gold-dim);
      box-shadow: 0 0 0 3px rgba(232,200,74,0.12);
    }

    select option { background: var(--navy-mid); }

    .btn-load {
      background: var(--red);
      border: none;
      border-radius: 10px;
      color: white;
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.1rem;
      letter-spacing: 2px;
      padding: 12px 32px;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s, box-shadow 0.2s;
      white-space: nowrap;
      box-shadow: 0 4px 16px rgba(200,16,46,0.3);
    }

    .btn-load:hover { background: var(--red-dark); box-shadow: 0 6px 20px rgba(200,16,46,0.45); }
    .btn-load:active { transform: scale(0.97); }
    .btn-load:disabled { background: var(--navy-light); box-shadow: none; cursor: not-allowed; }

    /* ── LOADING SPINNER ── */
    .spinner {
      display: none;
      width: 20px; height: 20px;
      border: 2px solid rgba(255,255,255,0.2);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      margin: 0 auto;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ── ROSTER SECTION ── */
    #roster-section {
      display: none;
      animation: fadeUp 0.4s ease;
    }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(16px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .roster-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .roster-title {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1.8rem;
      letter-spacing: 1px;
    }

    .roster-title span {
      color: var(--gold);
    }

    .tabs {
      display: flex;
      gap: 6px;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 4px;
    }

    .tab {
      background: none;
      border: none;
      color: var(--gray);
      font-family: 'DM Sans', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      letter-spacing: 1px;
      padding: 8px 20px;
      border-radius: 7px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tab.active {
      background: var(--navy-light);
      color: var(--white);
    }

    /* ── PLAYER GRID ── */
    .player-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 12px;
    }

    .player-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px 18px;
      cursor: pointer;
      transition: border-color 0.2s, transform 0.15s, box-shadow 0.2s;
      position: relative;
      overflow: hidden;
    }

    .player-card::before {
      content: '';
      position: absolute;
      left: 0; top: 0; bottom: 0;
      width: 3px;
      background: var(--border);
      transition: background 0.2s;
    }

    .player-card:hover {
      border-color: rgba(232,200,74,0.3);
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    }

    .player-card:hover::before { background: var(--gold); }

    .player-card.selected {
      border-color: var(--gold-dim);
      background: rgba(232,200,74,0.07);
    }

    .player-card.selected::before { background: var(--gold); }

    .player-name {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 4px;
    }

    .player-meta {
      font-size: 0.78rem;
      color: var(--gray);
      display: flex;
      gap: 10px;
    }

    .player-key-stat {
      font-size: 0.8rem;
      color: var(--gold-dim);
      margin-top: 8px;
      font-weight: 600;
    }

    /* ── STATS PANEL ── */
    #stats-section {
      display: none;
      margin-top: 40px;
      animation: fadeUp 0.4s ease;
    }

    .stats-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 32px;
    }

    .stats-player-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 32px;
      flex-wrap: wrap;
      gap: 16px;
    }

    .stats-player-name {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 2.4rem;
      letter-spacing: 1px;
      line-height: 1.1;
    }

    .stats-meta {
      display: flex;
      gap: 10px;
      margin-top: 6px;
      flex-wrap: wrap;
    }

    .badge {
      background: var(--navy-light);
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 0.75rem;
      letter-spacing: 1px;
      padding: 4px 10px;
      color: var(--gray);
      font-weight: 600;
    }

    .badge.batter { border-color: rgba(232,200,74,0.3); color: var(--gold-dim); }
    .badge.pitcher { border-color: rgba(200,16,46,0.3); color: #e87070; }

    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 16px;
    }

    .stat-box {
      background: var(--navy-mid);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
      text-align: center;
      transition: border-color 0.2s;
    }

    .stat-box:hover { border-color: rgba(232,200,74,0.25); }

    .stat-value {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 2rem;
      letter-spacing: 1px;
      color: var(--white);
      line-height: 1;
    }

    .stat-value.highlight { color: var(--gold); }

    .stat-label {
      font-size: 0.7rem;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--gray);
      margin-top: 6px;
    }

    /* ── AI ANALYSIS PANEL ── */
    .ai-panel {
      margin-top: 28px;
      border: 1px solid rgba(232,200,74,0.2);
      border-radius: 12px;
      overflow: hidden;
    }

    .ai-panel-header {
      background: linear-gradient(90deg, rgba(232,200,74,0.1), rgba(232,200,74,0.03));
      border-bottom: 1px solid rgba(232,200,74,0.15);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .ai-panel-title {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1rem;
      letter-spacing: 2px;
      color: var(--gold);
    }

    .btn-analyze {
      background: var(--gold);
      border: none;
      border-radius: 8px;
      color: var(--navy);
      font-family: 'Bebas Neue', sans-serif;
      font-size: 1rem;
      letter-spacing: 2px;
      padding: 10px 24px;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-analyze:hover { background: var(--gold-dim); }
    .btn-analyze:active { transform: scale(0.97); }
    .btn-analyze:disabled { background: var(--navy-light); color: var(--gray); cursor: not-allowed; }

    .ai-panel-body {
      padding: 24px;
    }

    /* idle state */
    .ai-idle {
      text-align: center;
      color: var(--gray);
      padding: 16px 0;
      font-size: 0.9rem;
      line-height: 1.6;
    }

    /* loading dots */
    .ai-loading {
      display: none;
      text-align: center;
      padding: 20px 0;
      color: var(--gray);
      font-size: 0.85rem;
      letter-spacing: 2px;
    }

    .dots span {
      display: inline-block;
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--gold-dim);
      margin: 0 3px;
      animation: bounce 1.2s infinite ease-in-out;
    }
    .dots span:nth-child(2) { animation-delay: 0.2s; }
    .dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }
      40% { transform: scale(1); opacity: 1; }
    }

    /* result */
    .ai-result { display: none; }

    .grade-display {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 24px;
      padding: 20px;
      background: var(--navy-mid);
      border-radius: 10px;
      border: 1px solid var(--border);
    }

    .grade-letter {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 4rem;
      line-height: 1;
      min-width: 72px;
      text-align: center;
    }

    .grade-a-plus  { color: #4ade80; text-shadow: 0 0 24px rgba(74,222,128,0.4); }
    .grade-a       { color: #86efac; text-shadow: 0 0 20px rgba(134,239,172,0.3); }
    .grade-a-minus { color: #bbf7d0; }
    .grade-b-plus  { color: #93c5fd; text-shadow: 0 0 20px rgba(147,197,253,0.3); }
    .grade-b       { color: #bfdbfe; }
    .grade-b-minus { color: #dbeafe; }
    .grade-c-plus  { color: var(--gold); }
    .grade-c       { color: var(--gold-dim); }
    .grade-c-minus { color: #d4a830; }
    .grade-d-plus  { color: #fb923c; }
    .grade-d       { color: #f97316; }
    .grade-d-minus { color: #ea580c; }
    .grade-f       { color: var(--red); text-shadow: 0 0 20px rgba(200,16,46,0.4); }

    .grade-detail { flex: 1; }

    .grade-detail .grade-label {
      font-size: 0.7rem;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: var(--gray);
      margin-bottom: 4px;
    }

    .grade-detail .grade-verdict {
      font-size: 0.9rem;
      color: var(--white);
      line-height: 1.5;
    }

    .ai-summary {
      font-size: 0.95rem;
      line-height: 1.75;
      color: #c8d8f0;
    }

    .ai-summary p { margin-bottom: 12px; }
    .ai-summary p:last-child { margin-bottom: 0; }

    /* error */
    .ai-error {
      display: none;
      color: #f87171;
      font-size: 0.9rem;
      text-align: center;
      padding: 12px 0;
    }

    /* ── ERROR / EMPTY ── */
    .message-box {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      color: var(--gray);
    }

    .message-box.error { border-color: rgba(200,16,46,0.3); }
    .message-box p { font-size: 0.95rem; line-height: 1.6; }

    /* ── RESPONSIVE ── */
    @media (max-width: 680px) {
      .controls { grid-template-columns: 1fr; }
      .btn-load { width: 100%; }
      .stat-grid { grid-template-columns: repeat(3, 1fr); }
    }
  </style>
</head>
<body>

<div class="wrapper">

  <!-- HEADER -->
  <header>
    <div class="header-text">
      <h1>MLB Player Analyzer</h1>
      <p>Select a team and season to explore player statistics</p>
    </div>
  </header>

  <!-- CONTROLS -->
  <div class="controls">
    <div class="control-group">
      <label>Team</label>
      <select id="team-select">
        <option value="">— Select a Team —</option>
        {% for abbr, name in teams.items() %}
        <option value="{{ abbr }}">{{ name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="control-group">
      <label>Season</label>
      <select id="year-select">
        {% for year in years %}
        <option value="{{ year }}" {% if year == 2025 %}selected{% endif %}>{{ year }}</option>
        {% endfor %}
      </select>
    </div>

    <button class="btn-load" id="load-btn" onclick="loadRoster()">
      <span id="btn-text">Load Roster</span>
      <div class="spinner" id="btn-spinner"></div>
    </button>
  </div>

  <!-- ROSTER SECTION -->
  <div id="roster-section">
    <div class="roster-header">
      <div class="roster-title" id="roster-title">Roster</div>
      <div class="tabs">
        <button class="tab active" id="tab-batters" onclick="showTab('batters')">Batters</button>
        <button class="tab" id="tab-pitchers" onclick="showTab('pitchers')">Pitchers</button>
      </div>
    </div>

    <div id="batters-grid" class="player-grid"></div>
    <div id="pitchers-grid" class="player-grid" style="display:none;"></div>
  </div>

  <!-- STATS SECTION -->
  <div id="stats-section">
    <div class="section-label">Player Stats</div>
    <div class="stats-card">
      <div class="stats-player-header">
        <div>
          <div class="stats-player-name" id="stats-name"></div>
          <div class="stats-meta" id="stats-meta"></div>
        </div>
      </div>
      <div class="stat-grid" id="stat-grid"></div>

      <!-- AI ANALYSIS PANEL -->
      <div class="ai-panel" id="ai-panel">
        <div class="ai-panel-header">
          <div class="ai-panel-title">&nbsp;Gemini AI Analysis</div>
          <button class="btn-analyze" id="analyze-btn" onclick="analyzePlayer()">
            <span id="analyze-btn-text">Analyze Player</span>
            <div class="spinner" id="analyze-spinner" style="display:none; width:16px; height:16px;"></div>
          </button>
        </div>
        <div class="ai-panel-body">
          <div class="ai-idle" id="ai-idle">
            Click <strong style="color:var(--gold-dim)">Analyze Player</strong> to get an AI-powered performance summary and letter grade from Gemini.
          </div>
          <div class="ai-loading" id="ai-loading">
            <div class="dots">
              <span></span><span></span><span></span>
            </div>
            <div style="margin-top:10px;">Gemini is analyzing the stats…</div>
          </div>
          <div class="ai-result" id="ai-result">
            <div class="grade-display">
              <div class="grade-letter" id="grade-letter">—</div>
              <div class="grade-detail">
                <div class="grade-label">Season Grade</div>
                <div class="grade-verdict" id="grade-verdict"></div>
              </div>
            </div>
            <div class="ai-summary" id="ai-summary"></div>
          </div>
          <div class="ai-error" id="ai-error"></div>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
  let rosterData = null;
  let selectedPlayer = null;
  let currentTab = 'batters';
  let currentPlayerData = null; // stores full stat object for AI call

  async function loadRoster() {
    const team = document.getElementById('team-select').value;
    const year = document.getElementById('year-select').value;

    if (!team) {
      alert('Please select a team first.');
      return;
    }

    // Loading state
    const btn = document.getElementById('load-btn');
    const btnText = document.getElementById('btn-text');
    const spinner = document.getElementById('btn-spinner');
    btn.disabled = true;
    btnText.style.display = 'none';
    spinner.style.display = 'block';

    // Hide existing sections
    document.getElementById('roster-section').style.display = 'none';
    document.getElementById('stats-section').style.display = 'none';
    selectedPlayer = null;
    currentPlayerData = null;

    try {
      const res = await fetch(`/api/players?team=${team}&year=${year}`);
      const data = await res.json();

      if (data.error) throw new Error(data.error);

      rosterData = data;
      renderRoster(data);

    } catch (err) {
      const section = document.getElementById('roster-section');
      section.innerHTML = `<div class="message-box error"><p>⚠️ Could not load roster: ${err.message}</p></div>`;
      section.style.display = 'block';
    } finally {
      btn.disabled = false;
      btnText.style.display = 'inline';
      spinner.style.display = 'none';
    }
  }

  function renderRoster(data) {
    document.getElementById('roster-title').innerHTML =
      `<span>${data.team}</span> &nbsp;·&nbsp; ${data.year}`;

    renderPlayerGrid('batters-grid', data.batters);
    renderPlayerGrid('pitchers-grid', data.pitchers);

    document.getElementById('roster-section').style.display = 'block';
    showTab('batters');
  }

  function renderPlayerGrid(gridId, players) {
    const grid = document.getElementById(gridId);
    if (!players || players.length === 0) {
      grid.innerHTML = '<div class="message-box"><p>No qualified players found.</p></div>';
      return;
    }

    grid.innerHTML = players.map(p => {
      const keyStat = p.type === 'Batter'
        ? `AVG ${p.avg.toFixed(3)} &nbsp;|&nbsp; ${p.hr} HR &nbsp;|&nbsp; OPS ${p.ops.toFixed(3)}`
        : `ERA ${p.era.toFixed(2)} &nbsp;|&nbsp; ${p.strikeouts} K &nbsp;|&nbsp; WHIP ${p.whip.toFixed(2)}`;

      return `
        <div class="player-card" onclick="selectPlayer('${escapeAttr(p.name)}', '${p.type}')" id="card-${escapeId(p.name)}">
          <div class="player-name">${p.name}</div>
          <div class="player-meta">
            <span>${p.type}</span>
            <span>${p.games} G</span>
          </div>
          <div class="player-key-stat">${keyStat}</div>
        </div>`;
    }).join('');
  }

  function showTab(tab) {
    currentTab = tab;
    document.getElementById('batters-grid').style.display = tab === 'batters' ? 'grid' : 'none';
    document.getElementById('pitchers-grid').style.display = tab === 'pitchers' ? 'grid' : 'none';
    document.getElementById('tab-batters').classList.toggle('active', tab === 'batters');
    document.getElementById('tab-pitchers').classList.toggle('active', tab === 'pitchers');
  }

  async function selectPlayer(name, type) {
    // Highlight selected card
    document.querySelectorAll('.player-card').forEach(c => c.classList.remove('selected'));
    const card = document.getElementById('card-' + escapeId(name));
    if (card) card.classList.add('selected');

    const year = document.getElementById('year-select').value;

    try {
      const res = await fetch(`/api/player-stats?name=${encodeURIComponent(name)}&year=${year}&type=${type}`);
      const data = await res.json();
      if (data.error) throw new Error(data.error);
      currentPlayerData = data;
      renderStats(data);
    } catch (err) {
      document.getElementById('stat-grid').innerHTML = `<div class="message-box error"><p>⚠️ ${err.message}</p></div>`;
      document.getElementById('stats-section').style.display = 'block';
    }
  }

  function renderStats(data) {
    document.getElementById('stats-name').textContent = data.name;

    const typeClass = data.type === 'Batter' ? 'batter' : 'pitcher';
    document.getElementById('stats-meta').innerHTML = `
      <span class="badge ${typeClass}">${data.type}</span>
      <span class="badge">${data.team}</span>
      <span class="badge">${data.year} Season</span>`;

    let statsHtml = '';
    if (data.type === 'Batter') {
      const items = [
        { label: 'AVG',  value: data.avg.toFixed(3),  highlight: data.avg >= 0.280 },
        { label: 'OPS',  value: data.ops.toFixed(3),  highlight: data.ops >= 0.800 },
        { label: 'HR',   value: data.home_runs,        highlight: data.home_runs >= 25 },
        { label: 'RBI',  value: data.rbi,              highlight: data.rbi >= 80 },
        { label: 'OBP',  value: data.obp.toFixed(3),  highlight: false },
        { label: 'SLG',  value: data.slg.toFixed(3),  highlight: false },
        { label: 'H',    value: data.hits,             highlight: false },
        { label: '2B',   value: data.doubles,          highlight: false },
        { label: '3B',   value: data.triples,          highlight: false },
        { label: 'SB',   value: data.stolen_bases,     highlight: false },
        { label: 'BB',   value: data.walks,            highlight: false },
        { label: 'SO',   value: data.strikeouts,       highlight: false },
        { label: 'G',    value: data.games,            highlight: false },
        { label: 'WAR',  value: data.war,              highlight: data.war >= 4 },
        { label: 'wRC+', value: data.wrc_plus,         highlight: data.wrc_plus !== 'N/A' && data.wrc_plus >= 120 },
      ];
      statsHtml = items.map(s =>
        `<div class="stat-box">
          <div class="stat-value ${s.highlight ? 'highlight' : ''}">${s.value}</div>
          <div class="stat-label">${s.label}</div>
        </div>`).join('');
    } else {
      const items = [
        { label: 'ERA',  value: data.era,              highlight: data.era <= 3.50 },
        { label: 'WHIP', value: data.whip,             highlight: data.whip <= 1.20 },
        { label: 'K',    value: data.strikeouts,       highlight: data.strikeouts >= 150 },
        { label: 'W',    value: data.wins,             highlight: false },
        { label: 'L',    value: data.losses,           highlight: false },
        { label: 'SV',   value: data.saves,            highlight: false },
        { label: 'IP',   value: data.innings_pitched,  highlight: false },
        { label: 'BB',   value: data.walks,            highlight: false },
        { label: 'K/9',  value: data.k9,              highlight: false },
        { label: 'BB/9', value: data.bb9,             highlight: false },
        { label: 'FIP',  value: data.fip,             highlight: data.fip !== 'N/A' && data.fip <= 3.50 },
        { label: 'GS',   value: data.games_started,   highlight: false },
        { label: 'G',    value: data.games,            highlight: false },
        { label: 'WAR',  value: data.war,              highlight: data.war >= 4 },
      ];
      statsHtml = items.map(s =>
        `<div class="stat-box">
          <div class="stat-value ${s.highlight ? 'highlight' : ''}">${s.value}</div>
          <div class="stat-label">${s.label}</div>
        </div>`).join('');
    }

    document.getElementById('stat-grid').innerHTML = statsHtml;

    // Reset AI panel to idle state for the new player
    resetAiPanel();

    document.getElementById('stats-section').style.display = 'block';
    document.getElementById('stats-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  // ── AI ANALYSIS ──────────────────────────────────────────────────────────────

  function resetAiPanel() {
    document.getElementById('ai-idle').style.display = 'block';
    document.getElementById('ai-loading').style.display = 'none';
    document.getElementById('ai-result').style.display = 'none';
    document.getElementById('ai-error').style.display = 'none';
    document.getElementById('analyze-btn').disabled = false;
    document.getElementById('analyze-btn-text').textContent = 'Analyze Player';
    document.getElementById('analyze-spinner').style.display = 'none';
  }

  async function analyzePlayer() {
    if (!currentPlayerData) return;

    const btn = document.getElementById('analyze-btn');
    btn.disabled = true;
    document.getElementById('analyze-btn-text').textContent = 'Analyzing…';
    document.getElementById('analyze-spinner').style.display = 'inline-block';

    document.getElementById('ai-idle').style.display = 'none';
    document.getElementById('ai-result').style.display = 'none';
    document.getElementById('ai-error').style.display = 'none';
    document.getElementById('ai-loading').style.display = 'block';

    try {
      const res = await fetch('/api/analyze', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(currentPlayerData),
      });
      const data = await res.json();
      if (data.error) throw new Error(data.error);
      renderAiResult(data);
    } catch (err) {
      document.getElementById('ai-loading').style.display = 'none';
      const errEl = document.getElementById('ai-error');
      errEl.textContent = `Analysis failed: ${err.message}`;
      errEl.style.display = 'block';
      btn.disabled = false;
      document.getElementById('analyze-btn-text').textContent = 'Try Again';
      document.getElementById('analyze-spinner').style.display = 'none';
    }
  }

  function renderAiResult(data) {
    document.getElementById('ai-loading').style.display = 'none';

    // Map grade to CSS class
    const gradeClassMap = {
      'A+': 'grade-a-plus', 'A': 'grade-a', 'A-': 'grade-a-minus',
      'B+': 'grade-b-plus', 'B': 'grade-b', 'B-': 'grade-b-minus',
      'C+': 'grade-c-plus', 'C': 'grade-c', 'C-': 'grade-c-minus',
      'D+': 'grade-d-plus', 'D': 'grade-d', 'D-': 'grade-d-minus',
      'F':  'grade-f',
    };

    const gradeEl = document.getElementById('grade-letter');
    gradeEl.textContent = data.grade || '—';
    gradeEl.className = 'grade-letter ' + (gradeClassMap[data.grade] || '');

    document.getElementById('grade-verdict').textContent = data.grade_text || '';

    // Render summary — split on double newlines into paragraphs
    const summaryEl = document.getElementById('ai-summary');
    const paragraphs = (data.summary || '').split(/\n\n+/).filter(Boolean);
    summaryEl.innerHTML = paragraphs.map(p => `<p>${p.trim()}</p>`).join('');

    document.getElementById('ai-result').style.display = 'block';

    document.getElementById('analyze-btn').disabled = false;
    document.getElementById('analyze-btn-text').textContent = 'Re-analyze';
    document.getElementById('analyze-spinner').style.display = 'none';
  }

  // Helpers
  function escapeAttr(str) { return str.replace(/'/g, "\\'"); }
  function escapeId(str) { return str.replace(/[^a-zA-Z0-9]/g, '_'); }
</script>

</body>
</html>
